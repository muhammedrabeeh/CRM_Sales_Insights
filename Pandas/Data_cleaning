
import pandas as pd
from sqlalchemy import create_engine

# 1. LOAD DATA

sales = pd.read_excel("CRM_SALES.xlsx", sheet_name="SALES PIPELINE")

print("\nDataset Info:")
print(sales.info())

print("\nMissing Values:")
print(sales.isnull().sum())

# 2. DATA CLEANING

# Remove extra spaces in deal_stage
sales["deal_stage"] = sales["deal_stage"].str.strip()

print("\nUnique Deal Stages:")
print(sales["deal_stage"].unique())

# Convert date columns
sales["engage_date"] = pd.to_datetime(sales["engage_date"])
sales["close_date"] = pd.to_datetime(sales["close_date"])

print("\nDeal Stage Distribution:")
print(sales["deal_stage"].value_counts())


# 3. CREATE DEAL STATUS (Won=1, Lost=0)

sales["deal_status"] = sales["deal_stage"].map({
    "Won": 1,
    "Lost": 0,
    "Engaging": None,
    "Prospecting": None
})


# 4. DEAL DURATION ANALYSIS

print("\nAverage Deal Duration by Stage:")
print(sales.groupby("deal_stage")["deal_duration"].mean())


# 5. KPI CALCULATIONS

# Closed deals only
closed_deals = sales[sales["deal_status"].notna()]

# Win Rate
win_rate = closed_deals["deal_status"].mean()
print("\nWin Rate:", win_rate)

# Total Revenue (Won Deals)
total_revenue = sales[sales["deal_stage"] == "Won"]["close_value"].sum()
print("Total Revenue:", total_revenue)

# Average Deal Size
avg_deal_size = sales[sales["deal_stage"] == "Won"]["close_value"].mean()
print("Average Deal Size:", avg_deal_size)

# 6. SALES AGENT PERFORMANCE

# Revenue by Sales Agent (Won Deals)
agent_revenue = (
    sales[sales["deal_stage"] == "Won"]
    .groupby("sales_agent")["close_value"]
    .sum()
    .sort_values(ascending=False)
)

print("\nRevenue by Sales Agent:")
print(agent_revenue)


# Agent Performance (Revenue + Win Rate)
agent_performance = sales.groupby("sales_agent").agg({
    "close_value": "sum",
    "deal_status": "mean"
})

agent_performance = agent_performance.sort_values(
    "close_value", ascending=False
)

print("\nAgent Performance (Revenue & Win Rate):")
print(agent_performance)


# Closed Deals Count per Agent
deals_count = (
    closed_deals
    .groupby("sales_agent")["opportunity_id"]
    .count()
    .sort_values(ascending=False)
)

print("\nClosed Deals Count by Agent:")
print(deals_count)

# 7. EXPORT CLEAN DATA TO SQL

# Example PostgreSQL connection

engine = create_engine("postgresql://username:password@localhost:5432/your_database")

sales.to_sql(
    name="sales_pipeline_clean",
    con=engine,
    if_exists="replace",
    index=False
)

print("\nData successfully exported to SQL as 'sales_pipeline_clean'")


